<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Админка</title>
</head>
<body>

<div id="loginBox">
<h2>Вход</h2>
<input id="login" placeholder="логин"><br><br>
<input id="password" type="password" placeholder="пароль"><br><br>
<button onclick="login()">Войти</button>
<p id="error" style="color:red"></p>
</div>

<div id="adminBox" style="display:none;">
<h2>Заявки</h2>
<button onclick="exportCSV()">Экспорт</button>
<table border="1">
<thead>
<tr>
<th>ID</th><th>Имя</th><th>Телефон</th><th>Email</th><th>Дата</th><th></th>
</tr>
</thead>
<tbody id="table"></tbody>
</table>
</div>

<script>
let token = localStorage.getItem("token") || "";

if(token){
  document.getElementById("loginBox").style.display="none";
  document.getElementById("adminBox").style.display="block";
  loadPatients();
}

async function login(){
  const login = document.getElementById("login").value;
  const password = document.getElementById("password").value;

  const res = await fetch("/login",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({login,password})
  });

  if(!res.ok){
    document.getElementById("error").innerText="Ошибка входа";
    return;
  }

  const data = await res.json();
  token = data.token;
  localStorage.setItem("token", token);

  document.getElementById("loginBox").style.display="none";
  document.getElementById("adminBox").style.display="block";

  loadPatients();
}

async function loadPatients(){
  const token = localStorage.getItem("token");

  const res = await fetch("/patients",{
    headers:{
      "Authorization":"Bearer "+token
    }
  });

  const data = await res.json();
  const table = document.getElementById("table");
  table.innerHTML="";

  data.forEach(p=>{
    table.innerHTML += `
      <tr>
        <td>${p.id}</td>
        <td>${p.name}</td>
        <td>${p.phone}</td>
        <td>${p.email||""}</td>
        <td>${p.created_at}</td>
        <td><button onclick="del(${p.id})">Удалить</button></td>
      </tr>
    `;
  });
}

async function del(id){
  const token = localStorage.getItem("token");

  await fetch("/patients/"+id,{
    method:"DELETE",
    headers:{
      "Authorization":"Bearer "+token
    }
  });

  loadPatients();
}

function exportCSV(){
  const token = localStorage.getItem("token");
  window.location = "/export?token=" + token;
}
</script>

</body>
</html>
